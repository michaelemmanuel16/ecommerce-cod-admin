# KPI Formulas and Business Metrics

Common business metrics and KPI calculations for e-commerce COD operations.

## Sales & Revenue Metrics

### 1. Total Revenue
```
Total Revenue = Sum of all delivered order amounts
```

**Implementation:**
```typescript
const totalRevenue = await prisma.order.aggregate({
  where: { status: 'delivered' },
  _sum: { totalAmount: true }
});
```

### 2. Average Order Value (AOV)
```
AOV = Total Revenue / Number of Orders
```

**Implementation:**
```typescript
const aov = totalRevenue / orderCount;
```

### 3. Revenue Growth Rate
```
Growth Rate = ((Current Period Revenue - Previous Period Revenue) / Previous Period Revenue) √ó 100
```

**Example:**
```typescript
const currentMonthRevenue = 50000;
const lastMonthRevenue = 45000;
const growthRate = ((currentMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;
// Result: 11.11%
```

### 4. Daily Average Revenue
```
Daily Average = Total Revenue / Number of Days
```

## Conversion & Efficiency Metrics

### 5. Order Conversion Rate
```
Conversion Rate = (Delivered Orders / Total Orders) √ó 100
```

**Implementation:**
```typescript
const conversionRate = (deliveredOrders / totalOrders) * 100;
```

### 6. Cancellation Rate
```
Cancellation Rate = (Cancelled Orders / Total Orders) √ó 100
```

### 7. Return Rate
```
Return Rate = (Returned Orders / Delivered Orders) √ó 100
```

### 8. First Attempt Delivery Success Rate
```
Success Rate = (Successful First Deliveries / Total Delivery Attempts) √ó 100
```

## Customer Metrics

### 9. Customer Lifetime Value (CLV)
```
CLV = Average Order Value √ó Average Purchase Frequency √ó Average Customer Lifespan
```

**Simplified calculation:**
```typescript
const avgOrderValue = totalRevenue / totalOrders;
const avgPurchaseFrequency = totalOrders / uniqueCustomers;
const customerLifespan = 12; // months
const clv = avgOrderValue * avgPurchaseFrequency * customerLifespan;
```

### 10. Repeat Customer Rate
```
Repeat Rate = (Customers with >1 Order / Total Customers) √ó 100
```

**Implementation:**
```typescript
const repeatCustomers = await prisma.customer.count({
  where: {
    orders: {
      some: {
        status: 'delivered'
      }
    },
    _count: {
      orders: { gt: 1 }
    }
  }
});
const repeatRate = (repeatCustomers / totalCustomers) * 100;
```

### 11. Customer Acquisition Cost (CAC)
```
CAC = Total Marketing & Sales Costs / Number of New Customers
```

### 12. Average Revenue Per Customer
```
ARPC = Total Revenue / Total Customers
```

## Delivery & Operations Metrics

### 13. Average Delivery Time
```
Avg Delivery Time = Sum of (Delivery Time - Order Time) / Number of Deliveries
```

**Implementation:**
```typescript
const deliveries = await prisma.delivery.findMany({
  where: {
    actualDeliveryTime: { not: null }
  },
  include: {
    order: {
      select: { createdAt: true }
    }
  }
});

const totalMinutes = deliveries.reduce((sum, delivery) => {
  const diff = delivery.actualDeliveryTime.getTime() - delivery.order.createdAt.getTime();
  return sum + (diff / 1000 / 60); // Convert to minutes
}, 0);

const avgDeliveryTime = totalMinutes / deliveries.length;
```

### 14. On-Time Delivery Rate
```
On-Time Rate = (Deliveries On Time / Total Deliveries) √ó 100
```

### 15. Delivery Cost per Order
```
Cost per Order = Total Delivery Costs / Number of Delivered Orders
```

### 16. Agent Efficiency
```
Agent Efficiency = Successful Deliveries / Total Delivery Attempts
```

## Sales Rep Performance Metrics

### 17. Rep Conversion Rate
```
Rep Conversion Rate = (Rep's Delivered Orders / Rep's Total Orders) √ó 100
```

### 18. Revenue per Rep
```
Revenue per Rep = Total Revenue Generated by Rep / Rep's Active Days
```

### 19. Commission Earned
```
Commission = Rep's Total Revenue √ó Commission Rate
```

**Implementation:**
```typescript
const commission = repRevenue * (user.commissionRate / 100);
```

### 20. Average Order Value per Rep
```
AOV per Rep = Rep's Total Revenue / Rep's Number of Orders
```

## Inventory & Product Metrics

### 21. Inventory Turnover Rate
```
Turnover Rate = Cost of Goods Sold / Average Inventory Value
```

### 22. Stock-out Rate
```
Stock-out Rate = (Days Out of Stock / Total Days) √ó 100
```

### 23. Best-Selling Product Revenue
```
Product Revenue = Sum of (Quantity Sold √ó Price) for specific product
```

## Financial Metrics

### 24. Profit Margin
```
Profit Margin = ((Revenue - Costs) / Revenue) √ó 100
```

### 25. Cash Collection Rate
```
Collection Rate = (Cash Collected / Total COD Amount) √ó 100
```

### 26. Outstanding COD Amount
```
Outstanding = Total COD Orders - Cash Collected
```

## Trend Analysis Metrics

### 27. Moving Average
```
MA(n) = (Value‚ÇÅ + Value‚ÇÇ + ... + Value‚Çô) / n
```

**7-day moving average:**
```typescript
function calculateMovingAverage(data: number[], window: number) {
  const result = [];
  for (let i = 0; i < data.length; i++) {
    const start = Math.max(0, i - window + 1);
    const subset = data.slice(start, i + 1);
    const avg = subset.reduce((a, b) => a + b, 0) / subset.length;
    result.push(avg);
  }
  return result;
}
```

### 28. Compound Annual Growth Rate (CAGR)
```
CAGR = ((Ending Value / Beginning Value)^(1/Number of Years) - 1) √ó 100
```

### 29. Month-over-Month Growth
```
MoM Growth = ((Current Month - Previous Month) / Previous Month) √ó 100
```

### 30. Year-over-Year Growth
```
YoY Growth = ((Current Year - Previous Year) / Previous Year) √ó 100
```

## Cohort Analysis

### 31. Cohort Retention Rate
```
Retention Rate = (Active Users in Period / Original Cohort Size) √ó 100
```

**Example:**
```typescript
// Users who made first purchase in January
const januaryCohort = await prisma.customer.findMany({
  where: {
    createdAt: {
      gte: new Date('2024-01-01'),
      lt: new Date('2024-02-01')
    }
  }
});

// How many are still active in June?
const stillActive = await prisma.order.count({
  where: {
    customerId: { in: januaryCohort.map(c => c.id) },
    createdAt: {
      gte: new Date('2024-06-01'),
      lt: new Date('2024-07-01')
    }
  }
});

const retentionRate = (stillActive / januaryCohort.length) * 100;
```

## Forecasting Formulas

### 32. Linear Trend Forecast
```
Forecast = a + b √ó Period
where:
  a = intercept
  b = slope
```

### 33. Simple Moving Average Forecast
```
Forecast = Average of last n periods
```

### 34. Exponential Smoothing
```
Forecast = Œ± √ó Actual + (1 - Œ±) √ó Previous Forecast
where Œ± is smoothing constant (0 < Œ± < 1)
```

## Dashboard KPIs Summary

### Core Metrics (Always Display)
1. Total Revenue (today, this month, all time)
2. Total Orders (pending, delivered, all)
3. Average Order Value
4. Conversion Rate
5. Active Agents
6. Average Delivery Time

### Secondary Metrics
1. Growth Rate (MoM, YoY)
2. Top Performing Rep
3. Top Performing Agent
4. Best-Selling Product
5. Outstanding COD Amount

### Trending Indicators
- üìà Upward trend (>5% increase)
- üìâ Downward trend (>5% decrease)
- ‚û°Ô∏è Stable (<5% change)

## Visualization Recommendations

| Metric | Best Chart Type |
|--------|-----------------|
| Revenue over time | Line or Area |
| Orders by status | Pie or Donut |
| Rep performance | Bar |
| Delivery times | Line |
| Growth rates | Line with markers |
| Category breakdown | Pie |
| Trends comparison | Multi-line |
| Forecasts | Line with dashed forecast line |

## Calculation Examples

### Example 1: Weekly Performance Dashboard
```typescript
// Get last 7 days data
const weekData = await prisma.order.groupBy({
  by: ['createdAt'],
  where: {
    createdAt: {
      gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
    }
  },
  _count: true,
  _sum: { totalAmount: true }
});

// Calculate daily metrics
const dailyMetrics = weekData.map(day => ({
  date: day.createdAt,
  orders: day._count,
  revenue: day._sum.totalAmount,
  aov: day._sum.totalAmount / day._count
}));
```

### Example 2: Rep Leaderboard
```typescript
const repPerformance = await prisma.user.findMany({
  where: { role: 'sales_rep', isActive: true },
  include: {
    assignedOrdersAsRep: {
      where: { status: 'delivered' }
    }
  }
});

const leaderboard = repPerformance.map(rep => ({
  name: `${rep.firstName} ${rep.lastName}`,
  orders: rep.assignedOrdersAsRep.length,
  revenue: rep.assignedOrdersAsRep.reduce((sum, order) => sum + order.totalAmount, 0),
  commission: rep.assignedOrdersAsRep.reduce((sum, order) => sum + order.totalAmount, 0) * (rep.commissionRate / 100)
})).sort((a, b) => b.revenue - a.revenue);
```
