generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  super_admin
  admin
  manager
  sales_rep
  inventory_manager
  delivery_agent
  accountant
}

enum OrderStatus {
  pending_confirmation
  confirmed
  preparing
  ready_for_pickup
  out_for_delivery
  delivered
  cancelled
  returned
  failed_delivery
}

enum PaymentStatus {
  pending
  collected
  deposited
  reconciled
}

enum DeliveryProofType {
  signature
  photo
  otp
}

enum WorkflowTriggerType {
  webhook
  status_change
  time_based
  manual
}

enum WorkflowActionType {
  send_sms
  send_email
  update_order
  assign_agent
  add_tag
  wait
  http_request
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  firstName         String    @map("first_name")
  lastName          String    @map("last_name")
  phoneNumber       String?   @map("phone_number")
  role              UserRole
  isActive          Boolean   @default(true) @map("is_active")
  isAvailable       Boolean   @default(true) @map("is_available")
  lastLogin         DateTime? @map("last_login")
  refreshToken      String?   @map("refresh_token")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  assignedOrdersAsRep    Order[]        @relation("OrderCustomerRep")
  assignedOrdersAsAgent  Order[]        @relation("OrderDeliveryAgent")
  deliveries             Delivery[]
  createdOrders          Order[]        @relation("OrderCreatedBy")
  notifications          Notification[]
  expenses               Expense[]

  @@map("users")
}

model Customer {
  id                String    @id @default(cuid())
  firstName         String    @map("first_name")
  lastName          String    @map("last_name")
  email             String?
  phoneNumber       String    @unique @map("phone_number")
  alternatePhone    String?   @map("alternate_phone")
  address           String
  city              String
  state             String
  zipCode           String    @map("zip_code")
  area              String
  landmark          String?
  tags              String[]  @default([])
  notes             String?
  totalOrders       Int       @default(0) @map("total_orders")
  totalSpent        Float     @default(0) @map("total_spent")
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  orders            Order[]

  @@index([phoneNumber])
  @@index([city])
  @@index([area])
  @@map("customers")
}

model Product {
  id                String    @id @default(cuid())
  sku               String    @unique
  name              String
  description       String?
  category          String
  price             Float
  costPrice         Float     @map("cost_price")
  stockQuantity     Int       @map("stock_quantity")
  lowStockThreshold Int       @default(10) @map("low_stock_threshold")
  imageUrl          String?   @map("image_url")
  weight            Float?
  dimensions        Json?
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  orderItems        OrderItem[]

  @@index([sku])
  @@index([category])
  @@map("products")
}

model Order {
  id                  String        @id @default(cuid())
  orderNumber         String        @unique @map("order_number")
  customerId          String        @map("customer_id")
  customerRepId       String?       @map("customer_rep_id")
  deliveryAgentId     String?       @map("delivery_agent_id")
  status              OrderStatus   @default(pending_confirmation)
  paymentStatus       PaymentStatus @default(pending) @map("payment_status")
  subtotal            Float
  shippingCost        Float         @default(0) @map("shipping_cost")
  discount            Float         @default(0)
  totalAmount         Float         @map("total_amount")
  codAmount           Float?        @map("cod_amount")
  notes               String?
  internalNotes       String?       @map("internal_notes")
  deliveryAddress     String        @map("delivery_address")
  deliveryCity        String        @map("delivery_city")
  deliveryState       String        @map("delivery_state")
  deliveryZipCode     String        @map("delivery_zip_code")
  deliveryArea        String        @map("delivery_area")
  estimatedDelivery   DateTime?     @map("estimated_delivery")
  priority            Int           @default(0)
  tags                String[]      @default([])
  source              String        @default("manual")
  externalOrderId     String?       @map("external_order_id")
  webhookData         Json?         @map("webhook_data")
  createdById         String?       @map("created_by_id")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  customer            Customer      @relation(fields: [customerId], references: [id])
  customerRep         User?         @relation("OrderCustomerRep", fields: [customerRepId], references: [id])
  deliveryAgent       User?         @relation("OrderDeliveryAgent", fields: [deliveryAgentId], references: [id])
  createdBy           User?         @relation("OrderCreatedBy", fields: [createdById], references: [id])
  orderItems          OrderItem[]
  orderHistory        OrderHistory[]
  delivery            Delivery?
  transaction         Transaction?

  @@index([orderNumber])
  @@index([customerId])
  @@index([status])
  @@index([customerRepId])
  @@index([deliveryAgentId])
  @@index([createdAt])
  @@index([deliveryArea])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String   @map("order_id")
  productId   String   @map("product_id")
  quantity    Int
  unitPrice   Float    @map("unit_price")
  totalPrice  Float    @map("total_price")
  createdAt   DateTime @default(now()) @map("created_at")

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderHistory {
  id          String      @id @default(cuid())
  orderId     String      @map("order_id")
  status      OrderStatus
  notes       String?
  changedBy   String?     @map("changed_by")
  metadata    Json?
  createdAt   DateTime    @default(now()) @map("created_at")

  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_history")
}

model Delivery {
  id                  String             @id @default(cuid())
  orderId             String             @unique @map("order_id")
  agentId             String             @map("agent_id")
  scheduledTime       DateTime?          @map("scheduled_time")
  actualDeliveryTime  DateTime?          @map("actual_delivery_time")
  proofType           DeliveryProofType? @map("proof_type")
  proofData           String?            @map("proof_data")
  proofImageUrl       String?            @map("proof_image_url")
  recipientName       String?            @map("recipient_name")
  recipientPhone      String?            @map("recipient_phone")
  notes               String?
  deliveryAttempts    Int                @default(0) @map("delivery_attempts")
  route               Json?
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")

  order               Order              @relation(fields: [orderId], references: [id])
  agent               User               @relation(fields: [agentId], references: [id])

  @@index([agentId])
  @@index([scheduledTime])
  @@map("deliveries")
}

model Transaction {
  id              String        @id @default(cuid())
  orderId         String?       @unique @map("order_id")
  type            String
  amount          Float
  paymentMethod   String        @map("payment_method")
  status          PaymentStatus @default(pending)
  reference       String?
  description     String?
  metadata        Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  order           Order?        @relation(fields: [orderId], references: [id])

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model Expense {
  id          String   @id @default(cuid())
  category    String
  amount      Float
  description String
  receiptUrl  String?  @map("receipt_url")
  recordedBy  String   @map("recorded_by")
  expenseDate DateTime @map("expense_date")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [recordedBy], references: [id])

  @@index([category])
  @@index([expenseDate])
  @@map("expenses")
}

model Workflow {
  id          String                @id @default(cuid())
  name        String
  description String?
  triggerType WorkflowTriggerType   @map("trigger_type")
  triggerData Json                  @map("trigger_data")
  actions     Json
  conditions  Json?
  isActive    Boolean               @default(true) @map("is_active")
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")

  executions  WorkflowExecution[]

  @@map("workflows")
}

model WorkflowExecution {
  id          String   @id @default(cuid())
  workflowId  String   @map("workflow_id")
  status      String
  input       Json
  output      Json?
  error       String?
  startedAt   DateTime @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  workflow    Workflow @relation(fields: [workflowId], references: [id])

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("workflow_executions")
}

model WebhookConfig {
  id          String   @id @default(cuid())
  name        String
  url         String
  secret      String
  apiKey      String?  @map("api_key")
  isActive    Boolean  @default(true) @map("is_active")
  fieldMapping Json    @map("field_mapping")
  headers     Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  logs        WebhookLog[]

  @@map("webhook_configs")
}

model WebhookLog {
  id              String        @id @default(cuid())
  webhookConfigId String?       @map("webhook_config_id")
  endpoint        String
  method          String
  headers         Json
  body            Json
  response        Json?
  statusCode      Int?          @map("status_code")
  success         Boolean       @default(false)
  errorMessage    String?       @map("error_message")
  processedAt     DateTime      @default(now()) @map("processed_at")

  webhookConfig   WebhookConfig? @relation(fields: [webhookConfigId], references: [id])

  @@index([webhookConfigId])
  @@index([processedAt])
  @@map("webhook_logs")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}
