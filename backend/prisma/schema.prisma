generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int            @id @default(autoincrement())
  email                 String         @unique
  password              String
  phoneNumber           String?        @map("phone_number")
  role                  UserRole
  isActive              Boolean        @default(true) @map("is_active")
  isAvailable           Boolean        @default(true) @map("is_available")
  lastLogin             DateTime?      @map("last_login")
  refreshToken          String?        @map("refresh_token")
  commissionRate        Float?         @default(0) @map("commission_rate")
  country               String?
  preferences           Json?
  vehicleType           String?        @map("vehicle_type")
  vehicleId             String?        @map("vehicle_id")
  deliveryRate          Float?         @default(0) @map("delivery_rate")
  totalEarnings         Float?         @default(0) @map("total_earnings")
  location              String?
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")
  firstName             String         @map("first_name")
  lastName              String         @map("last_name")
  calls                 Call[]         @relation("CallSalesRep")
  deliveries            Delivery[]
  expenses              Expense[]
  notifications         Notification[]
  createdOrders         Order[]        @relation("OrderCreatedBy")
  assignedOrdersAsRep   Order[]        @relation("OrderCustomerRep")
  assignedOrdersAsAgent Order[]        @relation("OrderDeliveryAgent")
  payouts               Payout[]
  auditLogs             AuditLog[]

  @@index([role, isActive])
  @@index([role, isActive, isAvailable])
  @@map("users")
}

model Customer {
  id             Int      @id @default(autoincrement())
  email          String?
  phoneNumber    String   @unique @map("phone_number")
  alternatePhone String?  @map("alternate_phone")
  address        String
  state          String
  area           String
  landmark       String?
  tags           String[] @default([])
  notes          String?
  totalOrders    Int      @default(0) @map("total_orders")
  totalSpent     Float    @default(0) @map("total_spent")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  calls          Call[]
  orders         Order[]

  @@index([isActive])
  @@index([email])
  @@index([area])
  @@index([totalSpent])
  @@map("customers")
}

model Product {
  id                   Int                    @id @default(autoincrement())
  sku                  String                 @unique
  name                 String
  description          String?
  category             String
  price                Float
  stockQuantity        Int                    @map("stock_quantity")
  lowStockThreshold    Int                    @default(10) @map("low_stock_threshold")
  imageUrl             String?                @map("image_url")
  weight               Float?
  dimensions           Json?
  isActive             Boolean                @default(true) @map("is_active")
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")
  batch_quantity       Int                    @default(1)
  cogs                 Float                  @default(0)
  checkoutForms        CheckoutForm[]
  formUpsells          FormUpsell[]
  orderItems           OrderItem[]
  product_cost_entries product_cost_entries[]
  webhookConfigs       WebhookConfig[]

  @@index([isActive])
  @@index([category, isActive])
  @@index([stockQuantity])
  @@map("products")
}

model Order {
  id                Int              @id @default(autoincrement())
  customerId        Int              @map("customer_id")
  customerRepId     Int?             @map("customer_rep_id")
  deliveryAgentId   Int?             @map("delivery_agent_id")
  status            OrderStatus      @default(pending_confirmation)
  paymentStatus     PaymentStatus    @default(pending) @map("payment_status")
  subtotal          Float
  shippingCost      Float            @default(0) @map("shipping_cost")
  discount          Float            @default(0)
  totalAmount       Float            @map("total_amount")
  codAmount         Float?           @map("cod_amount")
  notes             String?
  internalNotes     String?          @map("internal_notes")
  deliveryAddress   String           @map("delivery_address")
  deliveryState     String           @map("delivery_state")
  deliveryArea      String           @map("delivery_area")
  estimatedDelivery DateTime?        @map("estimated_delivery")
  priority          Int              @default(0)
  tags              String[]         @default([])
  source            String           @default("manual")
  externalOrderId   String?          @map("external_order_id")
  webhookData       Json?            @map("webhook_data")
  createdById       Int?             @map("created_by_id")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  deletedAt         DateTime?        @map("deleted_at")
  commissionPaid    Boolean          @default(false) @map("commission_paid")
  payoutId          Int?             @map("payout_id")
  calls             Call[]
  delivery          Delivery?
  formSubmissions   FormSubmission[]
  orderHistory      OrderHistory[]
  orderItems        OrderItem[]
  createdBy         User?            @relation("OrderCreatedBy", fields: [createdById], references: [id])
  customer          Customer         @relation(fields: [customerId], references: [id])
  customerRep       User?            @relation("OrderCustomerRep", fields: [customerRepId], references: [id])
  deliveryAgent     User?            @relation("OrderDeliveryAgent", fields: [deliveryAgentId], references: [id])
  transaction       Transaction?
  payout            Payout?          @relation(fields: [payoutId], references: [id])

  @@index([customerId])
  @@index([status])
  @@index([customerRepId])
  @@index([deliveryAgentId])
  @@index([createdAt])
  @@index([deliveryArea])
  @@index([status, createdAt])
  @@index([paymentStatus, status])
  @@index([deliveryArea, status])
  @@index([deliveryAgentId, status])
  @@index([customerRepId, status])
  @@index([source])
  @@index([customerId, createdAt])
  @@index([deliveryState, deliveryArea])
  @@index([deletedAt])
  @@map("orders")
}

model OrderItem {
  id         Int      @id @default(autoincrement())
  orderId    Int      @map("order_id")
  productId  Int      @map("product_id")
  quantity   Int
  unitPrice  Float    @map("unit_price")
  totalPrice Float    @map("total_price")
  createdAt  DateTime @default(now()) @map("created_at")
  itemType   String   @default("package") @map("item_type")
  metadata   Json?
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderHistory {
  id        Int         @id @default(autoincrement())
  orderId   Int         @map("order_id")
  status    OrderStatus
  notes     String?
  metadata  Json?
  createdAt DateTime    @default(now()) @map("created_at")
  changedBy Int?        @map("changed_by")
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_history")
}

model Delivery {
  id                 Int                @id @default(autoincrement())
  orderId            Int                @unique @map("order_id")
  agentId            Int?               @map("agent_id")
  scheduledTime      DateTime?          @map("scheduled_time")
  actualDeliveryTime DateTime?          @map("actual_delivery_time")
  proofType          DeliveryProofType? @map("proof_type")
  proofData          String?            @map("proof_data")
  proofImageUrl      String?            @map("proof_image_url")
  recipientName      String?            @map("recipient_name")
  recipientPhone     String?            @map("recipient_phone")
  notes              String?
  deliveryAttempts   Int                @default(0) @map("delivery_attempts")
  route              Json?
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  agent              User?              @relation(fields: [agentId], references: [id])
  order              Order              @relation(fields: [orderId], references: [id])

  @@index([agentId])
  @@index([scheduledTime])
  @@index([agentId, scheduledTime])
  @@index([orderId, actualDeliveryTime])
  @@index([scheduledTime, actualDeliveryTime])
  @@map("deliveries")
}

model Transaction {
  id            Int           @id @default(autoincrement())
  orderId       Int?          @unique @map("order_id")
  type          String
  amount        Float
  paymentMethod String        @map("payment_method")
  status        PaymentStatus @default(pending)
  reference     String?
  description   String?
  metadata      Json?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  order         Order?        @relation(fields: [orderId], references: [id])

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([type, status])
  @@index([type, createdAt])
  @@index([status, createdAt])
  @@map("transactions")
}

model Expense {
  id          Int      @id @default(autoincrement())
  category    String
  amount      Float
  description String
  receiptUrl  String?  @map("receipt_url")
  recordedBy  Int?     @map("recorded_by")
  expenseDate DateTime @map("expense_date")
  createdAt   DateTime @default(now()) @map("created_at")
  user        User?    @relation(fields: [recordedBy], references: [id])

  @@index([category])
  @@index([expenseDate])
  @@map("expenses")
}

model Account {
  id            Int           @id @default(autoincrement())
  code          String        @unique
  name          String
  description   String?
  accountType   AccountType   @map("account_type")
  normalBalance NormalBalance @map("normal_balance")
  parentId      Int?          @map("parent_id")
  isSystem      Boolean       @default(false) @map("is_system")
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  parent        Account?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children      Account[]     @relation("AccountHierarchy")

  @@index([accountType])
  @@index([isActive])
  @@index([parentId])
  @@index([code])
  @@map("accounts")
}

model Workflow {
  id          Int                 @id @default(autoincrement())
  name        String
  description String?
  triggerType WorkflowTriggerType @map("trigger_type")
  triggerData Json                @map("trigger_data")
  actions     Json
  conditions  Json?
  isActive    Boolean             @default(true) @map("is_active")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  executions  WorkflowExecution[]

  @@index([isActive])
  @@index([triggerType])
  @@index([createdAt])
  @@index([isActive, triggerType])
  @@map("workflows")
}

model WorkflowExecution {
  id          Int       @id @default(autoincrement())
  workflowId  Int       @map("workflow_id")
  status      String
  input       Json
  output      Json?
  error       String?
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  workflow    Workflow  @relation(fields: [workflowId], references: [id])

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("workflow_executions")
}

model WebhookConfig {
  id           Int          @id @default(autoincrement())
  name         String
  url          String
  secret       String
  apiKey       String?      @map("api_key")
  isActive     Boolean      @default(true) @map("is_active")
  fieldMapping Json         @map("field_mapping")
  headers      Json?
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  uniqueUrl    String       @unique @default(uuid()) @map("unique_url")
  productId    Int?         @map("product_id")
  product      Product?     @relation(fields: [productId], references: [id])
  logs         WebhookLog[]

  @@index([productId])
  @@map("webhook_configs")
}

model WebhookLog {
  id              Int            @id @default(autoincrement())
  webhookConfigId Int?           @map("webhook_config_id")
  endpoint        String
  method          String
  headers         Json
  body            Json
  response        Json?
  statusCode      Int?           @map("status_code")
  success         Boolean        @default(false)
  errorMessage    String?        @map("error_message")
  processedAt     DateTime       @default(now()) @map("processed_at")
  webhookConfig   WebhookConfig? @relation(fields: [webhookConfigId], references: [id])

  @@index([webhookConfigId])
  @@index([processedAt])
  @@map("webhook_logs")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  type      String
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model SystemConfig {
  id                    Int      @id @default(autoincrement())
  businessName          String?  @map("business_name")
  businessEmail         String?  @map("business_email")
  businessPhone         String?  @map("business_phone")
  businessAddress       String?  @map("business_address")
  taxId                 String?  @map("tax_id")
  currency              String   @default("USD")
  operatingHours        Json?    @map("operating_hours")
  smsProvider           Json?    @map("sms_provider")
  emailProvider         Json?    @map("email_provider")
  notificationTemplates Json?    @map("notification_templates")
  rolePermissions       Json?    @map("role_permissions")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

model CheckoutForm {
  id          Int              @id @default(autoincrement())
  name        String
  slug        String           @unique
  productId   Int              @map("product_id")
  description String?
  fields      Json
  styling     Json
  country     String           @default("Ghana")
  regions     Json
  isActive    Boolean          @default(true) @map("is_active")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  currency    String           @default("GHS")
  product     Product          @relation(fields: [productId], references: [id])
  packages    FormPackage[]
  submissions FormSubmission[]
  upsells     FormUpsell[]

  @@index([slug])
  @@index([isActive])
  @@map("checkout_forms")
}

model FormPackage {
  id            Int          @id @default(autoincrement())
  formId        Int          @map("form_id")
  name          String
  description   String?
  price         Float
  quantity      Int
  discountType  String       @default("none") @map("discount_type")
  discountValue Float        @default(0) @map("discount_value")
  originalPrice Float?       @map("original_price")
  isPopular     Boolean      @default(false) @map("is_popular")
  isDefault     Boolean      @default(false) @map("is_default")
  sortOrder     Int          @default(0) @map("sort_order")
  createdAt     DateTime     @default(now()) @map("created_at")
  highlightText String?      @map("highlight_text")
  showDiscount  Boolean      @default(true) @map("show_discount")
  showHighlight Boolean      @default(false) @map("show_highlight")
  form          CheckoutForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@map("form_packages")
}

model FormUpsell {
  id            Int          @id @default(autoincrement())
  formId        Int          @map("form_id")
  name          String
  description   String?
  imageUrl      String?      @map("image_url")
  price         Float
  items         Json?
  sortOrder     Int          @default(0) @map("sort_order")
  createdAt     DateTime     @default(now()) @map("created_at")
  discountType  String       @default("none") @map("discount_type")
  discountValue Float        @default(0) @map("discount_value")
  originalPrice Float?       @map("original_price")
  productId     Int?         @map("product_id")
  form          CheckoutForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  product       Product?     @relation(fields: [productId], references: [id])

  @@index([formId])
  @@index([productId])
  @@map("form_upsells")
}

model FormSubmission {
  id              Int          @id @default(autoincrement())
  formId          Int          @map("form_id")
  orderId         Int?         @map("order_id")
  formData        Json         @map("form_data")
  selectedPackage Json         @map("selected_package")
  selectedUpsells Json?        @map("selected_upsells")
  totalAmount     Float        @map("total_amount")
  ipAddress       String?      @map("ip_address")
  userAgent       String?      @map("user_agent")
  createdAt       DateTime     @default(now()) @map("created_at")
  form            CheckoutForm @relation(fields: [formId], references: [id])
  order           Order?       @relation(fields: [orderId], references: [id])

  @@index([formId])
  @@index([orderId])
  @@index([createdAt])
  @@map("form_submissions")
}

model Call {
  id         Int         @id @default(autoincrement())
  orderId    Int?        @map("order_id")
  customerId Int         @map("customer_id")
  salesRepId Int         @map("sales_rep_id")
  outcome    CallOutcome
  duration   Int?
  notes      String?
  createdAt  DateTime    @default(now()) @map("created_at")
  customer   Customer    @relation(fields: [customerId], references: [id])
  order      Order?      @relation(fields: [orderId], references: [id])
  salesRep   User        @relation("CallSalesRep", fields: [salesRepId], references: [id])

  @@index([salesRepId])
  @@index([customerId])
  @@index([orderId])
  @@index([createdAt])
  @@index([salesRepId, createdAt])
  @@index([outcome])
  @@map("calls")
}

model Payout {
  id         Int      @id @default(autoincrement())
  repId      Int      @map("rep_id")
  amount     Float
  method     String
  status     String   @default("completed")
  payoutDate DateTime @default(now()) @map("payout_date")
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  rep    User    @relation(fields: [repId], references: [id])
  orders Order[]

  @@index([repId])
  @@index([payoutDate])
  @@map("payouts")
}

model product_cost_entries {
  id              Int      @id @default(autoincrement())
  product_id      Int
  category        String   @default("purchase")
  amount          Float
  description     String?
  date            DateTime @default(now())
  created_at      DateTime @default(now())
  updated_at      DateTime
  referenceNumber String?
  supplier        String?
  products        Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([product_id])
}


model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  metadata   Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([resource, resourceId])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

enum UserRole {
  super_admin
  admin
  manager
  sales_rep
  inventory_manager
  delivery_agent
  accountant
}

enum OrderStatus {
  pending_confirmation
  confirmed
  preparing
  ready_for_pickup
  out_for_delivery
  delivered
  cancelled
  returned
  failed_delivery
}

enum PaymentStatus {
  pending
  collected
  deposited
  reconciled
}

enum DeliveryProofType {
  signature
  photo
  otp
}

enum WorkflowTriggerType {
  order_created
  status_change
  payment_received
  time_based
  manual
  webhook
}

enum WorkflowActionType {
  send_sms
  send_email
  update_order
  assign_agent
  add_tag
  wait
  http_request
}

enum CallOutcome {
  confirmed
  rescheduled
  no_answer
  cancelled
  other
}

enum AccountType {
  asset
  liability
  equity
  revenue
  expense
}

enum NormalBalance {
  debit
  credit
}
