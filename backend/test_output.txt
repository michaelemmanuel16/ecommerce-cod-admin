
> ecommerce-cod-admin-backend@1.0.0 test
> jest

ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/mac/Downloads/claude/ecommerce-cod-admin/backend/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/mac/Downloads/claude/ecommerce-cod-admin/backend/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/mac/Downloads/claude/ecommerce-cod-admin/backend/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/mac/Downloads/claude/ecommerce-cod-admin/backend/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/mac/Downloads/claude/ecommerce-cod-admin/backend/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/mac/Downloads/claude/ecommerce-cod-admin/backend/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/mac/Downloads/claude/ecommerce-cod-admin/backend/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
FAIL src/__tests__/unit/webhook.test.ts
  Webhook Controller
    importOrdersViaWebhook
      âœ• should import orders successfully with valid API key (15 ms)
      âœ“ should verify webhook signature when provided (50 ms)
      âœ“ should reject invalid API key (13 ms)
      âœ• should handle multiple orders in batch (26 ms)

  â— Webhook Controller â€º importOrdersViaWebhook â€º should import orders successfully with valid API key

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"message": "Webhook processed", "results": ObjectContaining {"failed": 0, "success": 1}}
    Received: {"message": "Webhook processed", "results": {"errors": [{"error": "Cannot read properties of undefined (reading 'emit')", "order": {"address": "123 Main St", "amount": 100, "city": "New York", "customer_name": "John Doe", "customer_phone": "+1234567890", "id": "ext-order-1", "state": "NY", "zip": "10001"}}], "failed": 1, "success": 1}}

    Number of calls: 1

      86 |       await importOrdersViaWebhook(mockReq, mockRes);
      87 |
    > 88 |       expect(mockRes.json).toHaveBeenCalledWith(
         |                            ^
      89 |         expect.objectContaining({
      90 |           message: 'Webhook processed',
      91 |           results: expect.objectContaining({

      at Object.<anonymous> (src/__tests__/unit/webhook.test.ts:88:28)

  â— Webhook Controller â€º importOrdersViaWebhook â€º should handle multiple orders in batch

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"results": ObjectContaining {"failed": 0, "success": 2}}
    Received: {"message": "Webhook processed", "results": {"errors": [{"error": "Cannot read properties of undefined (reading 'emit')", "order": {"amount": 50, "customer_name": "User 1", "customer_phone": "+1111111111", "id": "ext-1"}}, {"error": "Cannot read properties of undefined (reading 'emit')", "order": {"amount": 75, "customer_name": "User 2", "customer_phone": "+2222222222", "id": "ext-2"}}], "failed": 2, "success": 2}}

    Number of calls: 1

      163 |       await importOrdersViaWebhook(mockReq, mockRes);
      164 |
    > 165 |       expect(mockRes.json).toHaveBeenCalledWith(
          |                            ^
      166 |         expect.objectContaining({
      167 |           results: expect.objectContaining({
      168 |             success: 2,

      at Object.<anonymous> (src/__tests__/unit/webhook.test.ts:165:28)

[32minfo[39m: Call logged {"callId":1,"customerId":1,"outcome":"confirmed","salesRepId":5,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Call logged {"callId":1,"customerId":1,"outcome":"confirmed","salesRepId":5,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Order created {"orderId":1,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Call logged {"callId":1,"customerId":1,"outcome":"confirmed","salesRepId":5,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Call logged {"callId":1,"customerId":1,"outcome":"confirmed","salesRepId":5,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Call logged {"callId":1,"customerId":1,"outcome":"confirmed","salesRepId":5,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Order status updated: 1 {"newStatus":"confirmed","oldStatus":"pending_confirmation","orderId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Status change workflows triggered {"newStatus":"confirmed","oldStatus":"pending_confirmation","orderId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowsTriggered":0}
[32minfo[39m: Order status updated: 1 {"newStatus":"delivered","oldStatus":"pending_confirmation","orderId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Status change workflows triggered {"newStatus":"delivered","oldStatus":"pending_confirmation","orderId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowsTriggered":0}
[32minfo[39m: Order cancelled: 1 {"orderId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Bulk import order created {"orderId":1,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to import order {"error":"Cannot read properties of undefined (reading 'emit')","orderData":{"customerFirstName":"John","customerLastName":"Doe","customerPhone":"+1234567890","deliveryAddress":"123 Main St","deliveryArea":"Manhattan","deliveryCity":"New York","deliveryState":"NY","deliveryZipCode":"10001","subtotal":100,"totalAmount":110},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Bulk import order created {"orderId":1,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to import order {"error":"Cannot read properties of undefined (reading 'emit')","orderData":{"customerFirstName":"John","customerLastName":"Doe","customerPhone":"+1234567890","deliveryAddress":"123 Main St","deliveryArea":"Manhattan","deliveryCity":"New York","deliveryState":"NY","deliveryZipCode":"10001","subtotal":100,"totalAmount":110},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Delivery created for order: order-1 {"agentId":"agent-1","deliveryId":"delivery-1","orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to import order {"error":"Database error","orderData":{"customerFirstName":"John","customerLastName":"Doe","customerPhone":"+1234567890","deliveryAddress":"123 Main St","deliveryArea":"Manhattan","deliveryCity":"New York","deliveryState":"NY","deliveryZipCode":"10001","subtotal":100,"totalAmount":110},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to emit socket events {"error":{},"orderId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to emit socket events {"error":{},"orderId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
FAIL src/__tests__/unit/orderService.test.ts
  OrderService
    createOrder
      âœ• should create order with valid data (16 ms)
      âœ“ should throw error when customer not found (12 ms)
      âœ“ should throw error when product not found (7 ms)
      âœ“ should throw error when product is out of stock (38 ms)
    updateOrderStatus
      âœ“ should update order status with valid transition (10 ms)
      âœ“ should allow any status transition for admin flexibility (17 ms)
      âœ“ should throw error when order not found (14 ms)
    cancelOrder
      âœ“ should cancel order and restock products (6 ms)
      âœ“ should throw error when cancelling delivered order (17 ms)
      âœ“ should throw error when cancelling already cancelled order (5 ms)
    bulkImportOrders
      âœ• should bulk import orders successfully (31 ms)
      âœ“ should create new customer if not exists (6 ms)
      âœ“ should handle errors and continue processing (19 ms)
    getOrderStats
      âœ“ should calculate order statistics correctly (18 ms)

  â— OrderService â€º createOrder â€º should create order with valid data

    TypeError: Cannot read properties of undefined (reading 'emit')

      63 | export function emitOrderCreated(io: SocketServer, order: any) {
      64 |   if (!io) return;
    > 65 |   io.to('role:admin').emit('order:created', order);
         |                      ^
      66 |   io.to('role:manager').emit('order:created', order);
      67 |   io.to('role:sales_rep').emit('order:created', order);
      68 | }

      at emitOrderCreated (src/sockets/index.ts:65:22)
      at OrderService.createOrder (src/services/orderService.ts:311:21)
      at Object.<anonymous> (src/__tests__/unit/orderService.test.ts:134:21)

  â— OrderService â€º bulkImportOrders â€º should bulk import orders successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: 0
    Received: 1

      329 |
      330 |       expect(results.success).toBe(1);
    > 331 |       expect(results.failed).toBe(0);
          |                              ^
      332 |       expect(results.errors).toHaveLength(0);
      333 |     });
      334 |

      at Object.<anonymous> (src/__tests__/unit/orderService.test.ts:331:30)

[31merror[39m: Failed to emit call logged event {"callId":1,"error":{},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to emit call logged event {"callId":1,"error":{},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to emit call logged event {"callId":1,"error":{},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to emit call logged event {"callId":1,"error":{},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[31merror[39m: Failed to emit call logged event {"callId":1,"error":{},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Delivery completed for order: order-1 {"deliveryId":"delivery-1","orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
PASS src/__tests__/unit/callService.test.ts
  CallService
    createCall
      âœ“ should create a call successfully with valid data (48 ms)
      âœ“ should create a call without orderId (14 ms)
      âœ“ should throw error if sales rep does not exist (52 ms)
      âœ“ should throw error if sales rep does not have permission (10 ms)
      âœ“ should allow admin to log calls (11 ms)
      âœ“ should allow manager to log calls (13 ms)
      âœ“ should allow super_admin to log calls (16 ms)
      âœ“ should throw error if customer does not exist (17 ms)
      âœ“ should throw error if order does not exist when orderId is provided (18 ms)
    getCalls
      âœ“ should return calls with default pagination (5 ms)
      âœ“ should filter calls by outcome (25 ms)
      âœ“ should filter calls by salesRepId (5 ms)
      âœ“ should filter calls by date range (25 ms)
      âœ“ should handle custom pagination (4 ms)
    getCallsByOrder
      âœ“ should return calls for specific order (22 ms)
    getCallsByCustomer
      âœ“ should return calls for specific customer (6 ms)
    getCallStats
      âœ“ should calculate stats for all reps (33 ms)
      âœ“ should filter stats by date range (23 ms)
      âœ“ should filter stats by specific rep (9 ms)
      âœ“ should handle empty call list (13 ms)

[32minfo[39m: Delivery completed for order: order-1 {"deliveryId":"delivery-1","orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Delivery created for order: order-1 {"agentId":"agent-1","deliveryId":"delivery-1","orderId":null,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Auto-assigned delivery agent: Agent One {"agentId":"agent-1","orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Workflow created {"name":"Order Confirmation SMS","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","triggerType":"status_change","workflowId":"workflow-1"}
[33mwarn[39m: Delivery failed for order: undefined {"deliveryId":"delivery-1","reason":"Customer not available","reschedule":true,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[33mwarn[39m: Delivery failed for order: undefined {"deliveryId":"delivery-1","reason":"Customer refused","reschedule":false,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
[32minfo[39m: Workflow execution started {"executionId":"execution-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowId":"workflow-1"}
[33mwarn[39m: Delivery failed for order: undefined {"deliveryId":"delivery-1","reason":"Customer not available","reschedule":true,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
PASS src/__tests__/unit/deliveryService.test.ts
  DeliveryService
    createDelivery
      âœ“ should create delivery assignment successfully (9 ms)
      âœ“ should throw error when order not found (39 ms)
      âœ“ should throw error when order is not ready (3 ms)
      âœ“ should throw error when delivery already exists (5 ms)
      âœ“ should throw error when agent is not available (16 ms)
      âœ“ should throw error when user is not a delivery agent (10 ms)
    completeDelivery
      âœ“ should complete delivery successfully (12 ms)
      âœ“ should throw error when delivery not found (18 ms)
      âœ“ should throw error when delivery already completed (7 ms)
      âœ“ should create COD transaction with correct amount (16 ms)
    autoAssignAgent
      âœ“ should auto-assign agent with lowest workload (6 ms)
      âœ“ should throw error when no available agents found (21 ms)
    getAgentRoute
      âœ“ should return deliveries for specified date range (7 ms)
      âœ“ should return empty array when no deliveries scheduled (19 ms)
    getAgentStats
      âœ“ should calculate agent statistics correctly (7 ms)
    markDeliveryFailed
      âœ“ should mark delivery as failed and increment attempts (48 ms)
      âœ“ should update order status to failed_delivery when not rescheduling (10 ms)
      âœ“ should update order status to ready_for_pickup when rescheduling (21 ms)

[32minfo[39m: Workflow conditions not met {"input":{"status":"pending"},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowId":"workflow-1"}
[32minfo[39m: Order updated via workflow {"orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","updateData":{"status":"confirmed"}}
[32minfo[39m: Test {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","to":"+1234567890"}
[32minfo[39m: Workflow execution completed {"executionId":"execution-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowId":"workflow-1"}
[32minfo[39m: Workflow execution completed {"executionId":"execution-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowId":"workflow-1"}
[31merror[39m: Workflow execution failed {"error":"Order not found","executionId":"execution-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowId":"workflow-1"}
[32minfo[39m: Test {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","to":"+1234567890"}
[32minfo[39m: Workflow execution completed {"executionId":"execution-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowId":"workflow-1"}
[31merror[39m: Workflow execution failed {"error":"Order not found","executionId":"execution-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","workflowId":"workflow-1"}
[32minfo[39m: Order updated via workflow {"orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58","updateData":{"notes":"Auto-confirmed","status":"confirmed"}}
[32minfo[39m: Agent assigned via workflow {"agentId":"agent-1","orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:58"}
PASS src/__tests__/unit/auth.test.ts
  Auth Controller
    login
      âœ“ should login user with valid credentials (3 ms)
      âœ“ should reject login with invalid credentials (5 ms)
      âœ“ should reject login for inactive user (4 ms)
    register
      âœ“ should register a new user (12 ms)
      âœ“ should reject registration with existing email (15 ms)
    refresh
      âœ“ should refresh access token with valid refresh token (12 ms)
    logout
      âœ“ should logout user successfully (22 ms)

[32minfo[39m: Tag added via workflow {"orderId":"order-1","service":"ecommerce-cod-api","tag":"urgent","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Tag added via workflow {"orderId":"order-1","service":"ecommerce-cod-api","tag":"urgent","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Workflow execution started {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","workflowId":"workflow-1"}
[32minfo[39m: Status change workflows triggered {"newStatus":"confirmed","oldStatus":"pending_confirmation","orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","workflowsTriggered":1}
[32minfo[39m: Status change workflows triggered {"newStatus":"confirmed","oldStatus":"pending","orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","workflowsTriggered":0}
[32minfo[39m: Workflow deleted {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","workflowId":"workflow-1"}
PASS src/__tests__/unit/workflowService.test.ts
  WorkflowService
    createWorkflow
      âœ“ should create workflow with valid data (3 ms)
      âœ“ should throw error with invalid action type (34 ms)
      âœ“ should throw error with empty actions array (2 ms)
    executeWorkflow
      âœ“ should execute active workflow successfully (3 ms)
      âœ“ should throw error when workflow not found (20 ms)
      âœ“ should throw error when workflow is not active (19 ms)
      âœ“ should return early when conditions not met (11 ms)
    processWorkflowExecution
      âœ“ should process workflow actions sequentially (5 ms)
      âœ“ should handle action errors gracefully (14 ms)
      âœ“ should stop execution on error when stopOnError is true (6 ms)
      âœ“ should mark execution as completed on success (22 ms)
      âœ“ should mark execution as failed on error (8 ms)
    evaluateConditions
      âœ“ should return true when conditions match (14 ms)
      âœ“ should return false when conditions do not match (4 ms)
      âœ“ should return true when no conditions specified (4 ms)
    executeAction - update_order
      âœ“ should update order successfully (25 ms)
      âœ“ should throw error when order ID not provided (12 ms)
    executeAction - assign_agent
      âœ“ should assign agent to order successfully (11 ms)
      âœ“ should throw error when agent ID not provided (30 ms)
    executeAction - add_tag
      âœ“ should add tag to order successfully (24 ms)
      âœ“ should not duplicate tags (6 ms)
    triggerStatusChangeWorkflows
      âœ“ should trigger workflows on status change (7 ms)
      âœ“ should not trigger workflows when none match (12 ms)
    deleteWorkflow
      âœ“ should delete workflow successfully (28 ms)
      âœ“ should throw error when workflow not found (6 ms)

[32minfo[39m: Customer created {"customerId":1,"phoneNumber":"+1234567890","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
PASS src/__tests__/unit/analyticsService.test.ts
  AnalyticsService
    getDashboardMetrics
      âœ“ should calculate dashboard metrics correctly (1 ms)
      âœ“ should handle zero orders gracefully (4 ms)
    getSalesTrends
      âœ“ should group sales data by day (5 ms)
      âœ“ should group sales data by month (10 ms)
      âœ“ should calculate conversion rate correctly (4 ms)
    getRepPerformance
      âœ“ should calculate rep performance metrics correctly (29 ms)
      âœ“ should handle reps with no orders (5 ms)
    getAgentPerformance
      âœ“ should calculate agent performance metrics correctly (16 ms)
    getCustomerInsights
      âœ“ should calculate customer insights correctly (11 ms)
    getProductPerformance
      âœ“ should calculate product sales performance (12 ms)
      âœ“ should handle products with no sales (8 ms)
    getAreaDistribution
      âœ“ should calculate area-wise order distribution (19 ms)
    getTimeSeriesData
      âœ“ should generate time series for orders metric (23 ms)
      âœ“ should generate time series for revenue metric (28 ms)
      âœ“ should only count delivered orders for revenue (45 ms)
    getRealTimeStats
      âœ“ should calculate real-time statistics (26 ms)

[32minfo[39m: Customer updated {"customerId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Customer updated {"customerId":"1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
PASS src/__tests__/unit/payoutController.test.ts
  Payout Controller
    getPendingPayments
      âœ“ should return pending payments for a valid rep ID (1 ms)
      âœ“ should throw AppError if rep ID is invalid (8 ms)
    getPayoutHistory
      âœ“ should return payout history for a valid rep ID
    processPayout
      âœ“ should process a payout successfully (1 ms)
      âœ“ should throw error if orderIds are missing or empty (1 ms)

[32minfo[39m: Customers merged {"primaryCustomerId":1,"secondaryCustomerId":2,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Customer tags added {"customerId":1,"newTags":["priority"],"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Customer tags added {"customerId":1,"newTags":["vip"],"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Environment validation passed {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Environment variables validated successfully {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Customer tags removed {"customerId":1,"service":"ecommerce-cod-api","tagsToRemove":["wholesale"],"timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Customer tags removed {"customerId":1,"service":"ecommerce-cod-api","tagsToRemove":["nonexistent"],"timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Socket.io instance registered for global access {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
PASS src/__tests__/unit/payoutService.test.ts
  PayoutService
    getPendingPayments
      âœ“ should return pending payments for a valid representative (9 ms)
      âœ“ should throw error if representative not found (19 ms)
      âœ“ should use updatedAt if actualDeliveryTime is missing (3 ms)
    getPayoutHistory
      âœ“ should return payout history for a representative (3 ms)
    processPayout
      âœ“ should process a payout within a transaction (16 ms)

PASS src/__tests__/unit/customerService.test.ts
  CustomerService
    createCustomer
      âœ“ should create customer with valid data (8 ms)
      âœ“ should throw error when phone number already exists (112 ms)
    updateCustomer
      âœ“ should update customer data successfully (3 ms)
      âœ“ should throw error when customer not found (4 ms)
      âœ“ should throw error when updating to duplicate phone number (19 ms)
      âœ“ should allow updating to same phone number (6 ms)
    getCustomerAnalytics
      âœ“ should calculate customer analytics correctly (4 ms)
      âœ“ should throw error when customer not found (2 ms)
      âœ“ should handle customer with no orders (8 ms)
    mergeCustomers
      âœ“ should merge customers successfully (5 ms)
      âœ“ should throw error when primary customer not found (12 ms)
      âœ“ should throw error when secondary customer not found (17 ms)
    addCustomerTags
      âœ“ should add new tags to existing tags (4 ms)
      âœ“ should not duplicate existing tags (3 ms)
    removeCustomerTags
      âœ“ should remove specified tags (3 ms)
      âœ“ should handle removing non-existent tags (3 ms)
    getTopCustomers
      âœ“ should return customers sorted by spending (8 ms)
      âœ“ should filter by city when specified (4 ms)
    searchCustomers
      âœ“ should search customers by phone number (3 ms)
      âœ“ should search customers by name case-insensitively (16 ms)
      âœ“ should filter by area when specified (3 ms)

PASS src/utils/__tests__/packageParser.test.ts
  Package Parser
    Pattern 1: BUY [NUMBER] SET(S) - GHâ‚µXXX
      âœ“ should parse "BUY ONE SET - GHâ‚µ250" (2 ms)
      âœ“ should parse "BUY TWO SETS - GHâ‚µ450" (1 ms)
      âœ“ should parse "BUY THREE SETS - GHâ‚µ650"
    Pattern 2: BUY [NUMBER]: GHCXXX
      âœ“ should parse "BUY ONE: GHC250" (1 ms)
      âœ“ should parse "BUY TWO: GHC450"
      âœ“ should parse "BUY THREE: GHC650" (1 ms)
    Pattern 3: BUY X GET X (NPCS): GHCXXX
      âœ“ should parse "BUY 1 GET 1 (2PCS): GHC250"
      âœ“ should parse "BUY 2 GET 2 (4PCS): GHC450"
      âœ“ should parse "BUY 3 GET 3 (6PCS): GHC650"
    Edge Cases
      âœ“ should handle different cedi formats (GHâ‚µ, GHC, GHS)
      âœ“ should handle lowercase input
      âœ“ should handle numeric quantities
      âœ“ should return defaults for empty string (1 ms)
      âœ“ should return defaults for invalid input
      âœ“ should handle null/undefined input (2 ms)
    isValidPackageString
      âœ“ should return true for valid package strings
      âœ“ should return false for invalid package strings (1 ms)

[32minfo[39m: Environment validation passed {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Environment variables validated successfully {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Socket.io instance registered for global access {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Environment validation passed {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Environment variables validated successfully {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Environment validation passed {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Environment variables validated successfully {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Socket.io instance registered for global access {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Socket.io instance registered for global access {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
PASS src/__tests__/unit/orders.test.ts
  Orders Controller
    getAllOrders
      âœ“ should return paginated orders (1 ms)
      âœ“ should filter orders by status
      âœ“ should search orders by order number (9 ms)
    createOrder
      âœ“ should create a new order (2 ms)
    getOrder
      âœ“ should return order by id
      âœ“ should throw error if order not found (12 ms)
    updateOrderStatus
      âœ“ should update order status (1 ms)

[32minfo[39m: Expense recorded {"amount":500,"category":"Delivery","expenseId":"expense-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Webhook order created {"orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[34mdebug[39m: No active order_created workflows found {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[31merror[39m: Webhook processing error {"error":"Invalid API key","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","webhookLogId":"log-1"}
[32minfo[39m: Transaction reconciled {"orderId":"order-1","service":"ecommerce-cod-api","status":"reconciled","timestamp":"2026-01-06 20:10:59","transactionId":"trans-1"}
[32minfo[39m: Customer created from webhook {"customerId":"customer-new","phoneNumber":"+1234567890","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Webhook order created {"orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[34mdebug[39m: No active order_created workflows found {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Transaction reconciled {"orderId":"order-1","service":"ecommerce-cod-api","status":"deposited","timestamp":"2026-01-06 20:10:59","transactionId":"trans-1"}
[32minfo[39m: COD marked as deposited {"count":3,"depositReference":"DEP-2024-001","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","transactionIds":["trans-1","trans-2","trans-3"]}
[32minfo[39m: Customer created from webhook {"customerId":"customer-1","phoneNumber":"+1234567890","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Webhook order created {"orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[34mdebug[39m: No active order_created workflows found {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Customer created from webhook {"customerId":"customer-1","phoneNumber":"+9876543210","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: Webhook order created {"orderId":"order-1","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[34mdebug[39m: No active order_created workflows found {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[32minfo[39m: COD marked as deposited {"count":2,"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","transactionIds":["trans-1","trans-2"]}
[31merror[39m: Failed to process webhook order {"error":"Database error","orderData":{"address":"123 Main St","amount":100,"area":"Manhattan","city":"New York","customer_phone":"+1234567890","state":"NY","zip":"10001"},"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[31merror[39m: Webhook processing error {"error":"Invalid API key","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","webhookLogId":"log-1"}
[32minfo[39m: Webhook configuration created {"name":"Shopify Orders","service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59","webhookId":"webhook-1"}
[32minfo[39m: Webhook order created {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
[34mdebug[39m: No active order_created workflows found {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:10:59"}
PASS src/__tests__/unit/financialService.test.ts
  FinancialService
    getFinancialSummary
      âœ“ should calculate financial summary correctly (27 ms)
      âœ“ should handle null aggregate values (6 ms)
    recordExpense
      âœ“ should record expense successfully (29 ms)
    getCODCollectionsByAgent
      âœ“ should get COD collections for specific agent (13 ms)
      âœ“ should filter by date range when provided (15 ms)
    reconcileTransaction
      âœ“ should reconcile transaction successfully (30 ms)
      âœ“ should throw error when transaction not found (15 ms)
      âœ“ should update order payment status (18 ms)
    markCODAsDeposited
      âœ“ should mark multiple transactions as deposited (14 ms)
      âœ“ should throw error when no transaction IDs provided (18 ms)
      âœ“ should only update collected transactions (15 ms)
    getFinancialReports
      âœ“ should generate daily financial reports (11 ms)
      âœ“ should generate monthly financial reports (16 ms)
    getExpenseBreakdown
      âœ“ should group expenses by category (26 ms)
    getAgentSettlement
      âœ“ should calculate agent settlement correctly (76 ms)
    calculateProfitMargins
      âœ“ should calculate profit margins correctly (122 ms)
      âœ“ should handle zero revenue (66 ms)
    getAllTransactions
      âœ“ should return paginated transactions (6 ms)
      âœ“ should filter by transaction type (73 ms)
      âœ“ should filter by payment status (16 ms)

[32minfo[39m: Webhook configuration deleted {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:11:00","webhookId":"webhook-1"}
[32minfo[39m: Webhook configuration updated {"service":"ecommerce-cod-api","timestamp":"2026-01-06 20:11:00","webhookId":"webhook-1"}
PASS src/__tests__/unit/webhookService.test.ts
  WebhookService
    verifySignature
      âœ“ should verify valid signature correctly (20 ms)
      âœ“ should verify signature with sha256= prefix (3 ms)
      âœ“ should reject invalid signature (2 ms)
      âœ“ should handle verification errors gracefully (1 ms)
    processWebhook
      âœ“ should process webhook successfully with valid API key (12 ms)
      âœ“ should throw error with invalid API key (47 ms)
      âœ“ should create new customer if not exists (25 ms)
      âœ“ should handle multiple orders in webhook (51 ms)
      âœ“ should log failed orders and continue processing (24 ms)
      âœ“ should update webhook log on error (18 ms)
    createWebhook
      âœ“ should create webhook configuration (9 ms)
    testWebhook
      âœ“ should test field mapping successfully (38 ms)
      âœ“ should throw error when webhook not found (50 ms)
    retryWebhook
      âœ“ should retry failed webhook (60 ms)
      âœ“ should throw error when log not found (15 ms)
      âœ“ should throw error when retrying successful webhook (130 ms)
    getWebhookStats
      âœ“ should calculate webhook statistics correctly (17 ms)
      âœ“ should handle webhooks with no requests (44 ms)
    deleteWebhook
      âœ“ should delete webhook configuration (44 ms)
      âœ“ should throw error when webhook not found (8 ms)
    updateWebhook
      âœ“ should update webhook configuration (20 ms)
      âœ“ should throw error when webhook not found (10 ms)
    getWebhookLogs
      âœ“ should return paginated webhook logs (11 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Test Suites: 2 failed, 2 skipped, 12 passed, 14 of 16 total
Tests:       4 failed, 12 skipped, 198 passed, 214 total
Snapshots:   0 total
Time:        4.792 s, estimated 7 s
Ran all test suites.
